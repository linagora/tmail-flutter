# 69. Introduce `EMAIL_HTML_TAGS_TO_PRESERVE` for HTML sanitization extensibility

**Date:** 2025-11-27

## Status
Accepted

## Context

The email sanitization pipeline uses the class `StandardizeHtmlSanitizingTransformers` to process and clean incoming HTML content before rendering it in the UI.

This class defines internal static allowlists:

- `mailAllowedHtmlAttributes`
- `mailAllowedHtmlTags`

These default allowlists are fixed at compile-time. When new HTML tags appear in real-world emails (for example: `<form>`, `<section>`, `<font>`, `<center>`, or custom tags generated by email gateways or online editors), they may be stripped by the sanitization process.

Some environments or deployments may require additional custom tags to be preserved depending on operational constraints, customer integrations, or specific email formatting use cases.

Without configurability, adjusting the sanitization behavior requires code modifications and redeployment, which is not desirable.

## Decision

Introduce a new environment variable: **`EMAIL_HTML_TAGS_TO_PRESERVE`**.

This variable contains a comma-separated list of HTML tags that should be appended to `mailAllowedHtmlTags` at runtime.

The `StandardizeHtmlSanitizingTransformers` class will be updated to:

1. Read `EMAIL_HTML_TAGS_TO_PRESERVE` from the env configuration.
2. Parse the list into a trimmed `List<String>`.
3. Merge these tags into the existing `mailAllowedHtmlTags` list.
4. Ensure the final allowlist (default tags + preserve tags) is passed to `SanitizeHtml().process()` via the `allowTags` parameter.

The order of sanitization remains unchanged:

1. tags (including merged allowlist)
2. attributes
3. className

### Example usage inside the transformer:

```dart
final extendedTags = [
  ...mailAllowedHtmlTags,
  ...env.EMAIL_HTML_TAGS_TO_PRESERVE,
];
```

## Consequences

- The sanitization behavior becomes runtime-configurable and environment-specific.
- Ops teams can adjust preserved HTML tags without modifying source code or triggering a deployment.
- Rendering fidelity improves in cases where forwarded email chains, enterprise gateways, or WYSIWYG editors introduce non-standard HTML tags.
- The default behavior remains safe, while new tags can be adopted gradually and controllably.
- Any future modifications to tag/attribute/class preservation logic must be reflected in this ADR or new ADRs to maintain traceability.

## Example

### `.env`
```
EMAIL_HTML_TAGS_TO_PRESERVE=form,section,figure,figcaption
```
