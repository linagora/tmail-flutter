name: Build & Release

on:
  workflow_dispatch:
    inputs:
      build_android:
        description: 'Build Android app'
        required: false
        default: false
        type: boolean
      build_ios:
        description: 'Build iOS app'
        required: false
        default: false
        type: boolean
      build_docker:
        description: 'Build Docker image'
        required: false
        default: true
        type: boolean
      create_release:
        description: 'Create GitHub release'
        required: false
        default: false
        type: boolean
  push:
    tags:
      - 'v*'

# Prevent duplicate runs
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: 3.38.7
  XCODE_VERSION: 16.0
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/tmail-web

jobs:
  # Shared prebuild job - runs once and shares artifacts
  prebuild:
    name: Prebuild & Generate Code
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from git tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Extract version from tag (remove 'v' prefix)
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            # Fallback to pubspec.yaml version for manual dispatch
            VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"

      - name: Generate cache key
        id: cache-key
        run: echo "key=prebuild-${{ hashFiles('**/pubspec.lock', 'scripts/prebuild.sh') }}-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Check prebuild cache
        id: prebuild-cache
        uses: actions/cache@v4
        with:
          path: |
            .dart_tool/
            lib/**/*.g.dart
            lib/**/*.freezed.dart
            **/lib/**/*.g.dart
            **/lib/**/*.freezed.dart
          key: ${{ steps.cache-key.outputs.key }}

      - name: Setup Flutter
        if: steps.prebuild-cache.outputs.cache-hit != 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true
          cache-key: flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}

      - name: Cache pub dependencies
        if: steps.prebuild-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool/
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Install dependencies
        if: steps.prebuild-cache.outputs.cache-hit != 'true'
        run: flutter pub get

      - name: Run prebuild
        if: steps.prebuild-cache.outputs.cache-hit != 'true'
        run: ./scripts/prebuild.sh

  build-android:
    name: Build Android App
    runs-on: ubuntu-latest
    needs: prebuild
    if: ${{ inputs.build_android == true }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore prebuild cache
        uses: actions/cache@v4
        with:
          path: |
            .dart_tool/
            lib/**/*.g.dart
            lib/**/*.freezed.dart
            **/lib/**/*.g.dart
            **/lib/**/*.freezed.dart
          key: ${{ needs.prebuild.outputs.cache-key }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true
          cache-key: flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool/
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-${{ runner.os }}-

      - name: Setup Firebase env
        env:
          FIREBASE_ENV: ${{ secrets.FIREBASE_ENV }}
        run: ./scripts/setup-firebase.sh

      - name: Setup Android signing
        if: ${{ secrets.PLAY_STORE_UPLOAD_KEY_BASE64 != '' }}
        env:
          PLAY_STORE_UPLOAD_KEY_BASE64: ${{ secrets.PLAY_STORE_UPLOAD_KEY_BASE64 }}
          PLAY_STORE_KEY_INFO_BASE64: ${{ secrets.PLAY_STORE_KEY_INFO_BASE64 }}
        run: |
          cd android
          ../scripts/setup-android.sh

      - name: Install dependencies
        run: flutter pub get

      - name: Run prebuild (if cache miss)
        run: |
          if [ ! -f "lib/l10n/messages_all.dart" ]; then
            ./scripts/prebuild.sh
          fi

      - name: Build Android APK
        run: flutter build apk --release --build-name=${{ needs.prebuild.outputs.version }}

      - name: Build Android App Bundle
        run: flutter build appbundle --release --build-name=${{ needs.prebuild.outputs.version }}

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: tmail-android-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: Upload Android App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: tmail-android-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

  build-ios:
    name: Build iOS App
    runs-on: macos-latest
    needs: prebuild
    if: ${{ inputs.build_ios == true }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore prebuild cache
        uses: actions/cache@v4
        with:
          path: |
            .dart_tool/
            lib/**/*.g.dart
            lib/**/*.freezed.dart
            **/lib/**/*.g.dart
            **/lib/**/*.freezed.dart
          key: ${{ needs.prebuild.outputs.cache-key }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true
          cache-key: flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool/
          key: pub-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-${{ runner.os }}-

      - name: Select Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
          key: pods-ios-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: pods-ios-

      - name: Setup Firebase env
        env:
          FIREBASE_ENV: ${{ secrets.FIREBASE_ENV }}
        run: ./scripts/setup-firebase.sh

      - name: Install dependencies
        run: flutter pub get

      - name: Run prebuild (if cache miss)
        run: |
          if [ ! -f "lib/l10n/messages_all.dart" ]; then
            ./scripts/prebuild.sh
          fi

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install

      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign --build-name=${{ needs.prebuild.outputs.version }}

      - name: Create unsigned IPA
        run: |
          cd build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r TMail-iOS-unsigned.ipa Payload

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: tmail-ios
          path: build/ios/iphoneos/TMail-iOS-unsigned.ipa
          retention-days: 30

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: prebuild
    if: ${{ github.event_name == 'push' || inputs.build_docker == true }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            APP_VERSION=${{ needs.prebuild.outputs.version }}

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-android, build-ios, build-docker]
    if: |
      always() &&
      (startsWith(github.ref, 'refs/tags/v') || inputs.create_release) &&
      (needs.build-android.result == 'success' || needs.build-android.result == 'skipped') &&
      (needs.build-ios.result == 'success' || needs.build-ios.result == 'skipped') &&
      (needs.build-docker.result == 'success' || needs.build-docker.result == 'skipped')
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f \( -name "*.apk" -o -name "*.aab" -o -name "*.ipa" -o -name "*.dmg" -o -name "*.zip" -o -name "*.tar.gz" \) | sort

      - name: Get version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="dev-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: TMail ${{ steps.version.outputs.version }}
          draft: ${{ !startsWith(github.ref, 'refs/tags/v') }}
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: true
          files: |
            artifacts/tmail-android-apk/*.apk
            artifacts/tmail-android-aab/*.aab
            artifacts/tmail-ios/*.ipa
          body: |
            ## TMail ${{ steps.version.outputs.version }}

            ### Downloads

            | Platform | File | Description |
            |----------|------|-------------|
            | Android | `app-release.apk` | Android app (APK for sideloading) |
            | Android | `app-release.aab` | Android App Bundle (for Play Store) |
            | iOS | `TMail-iOS-unsigned.ipa` | iOS app (unsigned, requires re-signing) |

            ### Installation

            **Android**: Download the APK and install directly, or use the AAB for Play Store deployment.

            **iOS**: The IPA is unsigned. You'll need to re-sign it with your own provisioning profile using Xcode or a third-party tool.

            ### Web App (Docker)

            The web app is available via Docker image. Pull from GitHub Container Registry:

            ```bash
            docker pull ghcr.io/${{ github.repository_owner }}/tmail-web:${{ steps.version.outputs.version }}
            ```

            Or use the latest tag:

            ```bash
            docker pull ghcr.io/${{ github.repository_owner }}/tmail-web:latest
            ```

            Run the container:

            ```bash
            docker run -d -p 8080:80 ghcr.io/${{ github.repository_owner }}/tmail-web:${{ steps.version.outputs.version }}
            ```

            ---

            See the [CHANGELOG](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md) for details.
