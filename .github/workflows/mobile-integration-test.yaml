name: Mobile Integration Tests

on:
  pull_request:
    paths-ignore:
      - "docs/**"
      - "**/*.md"
  workflow_dispatch:
    inputs:
      run_ios:
        description: 'Run iOS tests'
        type: boolean
        default: true
      run_android:
        description: 'Run Android tests'
        type: boolean
        default: true

concurrency:
  group: mobile-tests-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: 3.38.7
  JAVA_VERSION: 17

jobs:
  android-integration-test:
    name: Android Integration Tests
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' || github.event.inputs.run_android == 'true' }}
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true
          cache-key: "flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}"

      - name: Setup Firebase env
        env:
          FIREBASE_ENV: ${{ secrets.FIREBASE_ENV }}
        run: ./scripts/setup-firebase.sh

      - name: Run prebuild
        run: ./scripts/prebuild.sh

      - name: Install Patrol CLI
        run: dart pub global activate patrol_cli

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Gradle cache
        uses: gradle/actions/setup-gradle@v3

      - name: AVD cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-api-33-${{ runner.os }}

      - name: Create AVD and generate snapshot for caching
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          target: google_apis
          arch: x86_64
          profile: pixel_6
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: echo "Generated AVD snapshot for caching."

      - name: Run Android integration tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          target: google_apis
          arch: x86_64
          profile: pixel_6
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            flutter build apk --debug --dart-define=BASIC_AUTH_URL=https://example.com
            patrol test --target integration_test/scenarios/app_grid_scenario.dart --verbose

      - name: Upload Android test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-test-results
          path: |
            build/app/reports/
            build/app/outputs/androidTest-results/

  ios-integration-test:
    name: iOS Integration Tests
    runs-on: macos-14
    if: ${{ github.event_name == 'pull_request' || github.event.inputs.run_ios == 'true' }}
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true
          cache-key: "flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}"

      - name: Setup Firebase env
        env:
          FIREBASE_ENV: ${{ secrets.FIREBASE_ENV }}
        run: ./scripts/setup-firebase.sh

      - name: Run prebuild
        run: ./scripts/prebuild.sh

      - name: Install Patrol CLI
        run: dart pub global activate patrol_cli

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.4.app

      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Boot iOS Simulator
        run: |
          UDID=$(xcrun simctl list devices available | grep "iPhone 15" | head -1 | grep -E -o '[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}')
          xcrun simctl boot "$UDID" || true
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install --repo-update
          cd ..

      - name: Run iOS integration tests
        run: |
          flutter build ios --debug --simulator --dart-define=BASIC_AUTH_URL=https://example.com
          patrol test --target integration_test/scenarios/app_grid_scenario.dart --verbose

      - name: Upload iOS test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-test-results
          path: |
            build/ios/
            ~/Library/Logs/DiagnosticReports/

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [android-integration-test, ios-integration-test]
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.android-integration-test.result }}" == "failure" ] || [ "${{ needs.ios-integration-test.result }}" == "failure" ]; then
            echo "One or more integration tests failed"
            exit 1
          fi
          echo "All integration tests passed!"
